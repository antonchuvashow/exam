{% extends "base.html" %}
{% block content %}
<!-- Шапка теста (фиксированная сверху) -->
<div id="test-header" class="fixed top-0 left-0 w-full bg-white shadow-md z-50">
    <div
        class="max-w-4xl mx-auto py-3 px-4 sm:px-6 flex flex-col sm:flex-row justify-between gap-3 sm:gap-6">
        <!-- Заголовок теста -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-1 sm:gap-2">
            <h1 class="text-lg sm:text-2xl font-bold text-gray-800 truncate max-w-[200px] sm:max-w-[400px]">
                {{ test.title }}
            </h1>
            {% if test.questions.count %}
            <span class="text-gray-500 text-sm sm:text-base">({{ test.questions.count }} вопросов)</span>
            {% endif %}
        </div>

        <!-- Таймер и предупреждения -->
        <div class="flex items-left gap-4 sm:gap-6">
            {% if remaining_seconds is not None %}
            <div id="timer"
                class="text-base sm:text-lg font-semibold text-indigo-700 bg-indigo-100 px-3 py-1 rounded-lg shadow-sm min-w-[60px] text-center">
            </div>
            {% endif %}
            <div id="warning-count"
                class="text-red-600 font-medium text-sm sm:text-base animate-pulse break-words">
            </div>
        </div>
    </div>
</div>

<div class="max-w-4xl mx-auto pt-28 pb-10">
    <!-- Форма теста -->
    <form id="test-form" method="post" action="{% url 'tests:submit_test' session.id %}" enctype="multipart/form-data"
        class="space-y-8">
        {% csrf_token %}
        <input type="hidden" name="client_token" id="client_token" value="{{ session.client_token }}">

        {% for q in questions %}
        <div
            class="bg-white shadow-md rounded-2xl p-6 border border-gray-100 hover:border-indigo-200 hover:shadow-lg transition duration-300">
            <div class="flex flex-col sm:flex-row items-start gap-6">
                {% if q.image %}
                <img src="{{ q.image.url }}" class="w-40 h-40 object-cover rounded-xl border border-gray-200"
                    alt="Изображение вопроса">
                {% endif %}

                <div class="flex-1">
                    <p class="font-semibold text-lg mb-3 text-gray-800">
                        {{ forloop.counter }}. {{ q.text }}
                        <span class="text-sm text-gray-500 ml-2">({{ q.points }} б.)</span>
                    </p>


                    {% if q.question_type == "single" %}
                    <div class="space-y-2">
                        {% for opt in q.options.all %}
                        <label
                            class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 hover:bg-indigo-50 cursor-pointer transition">
                            <input type="radio" name="q_{{ q.id }}" value="{{ opt.id }}"
                                class="accent-indigo-600 w-5 h-5 focus:ring-indigo-500 focus:ring-offset-1">
                            {% if opt.image %}
                            <img src="{{ opt.image.url }}"
                                class="w-16 h-16 object-cover rounded-md border border-gray-300" alt="">
                            {% endif %}
                            <span class="text-gray-700">{{ opt.text }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    {% elif q.question_type == "multiple" %}
                    <div class="space-y-2">
                        {% for opt in q.options.all %}
                        <label
                            class="flex items-center space-x-3 p-3 rounded-lg border border-gray-200 hover:bg-indigo-50 cursor-pointer transition">
                            <input type="checkbox" name="q_{{ q.id }}" value="{{ opt.id }}"
                                class="accent-indigo-600 w-5 h-5 focus:ring-indigo-500 focus:ring-offset-1">
                            {% if opt.image %}
                            <img src="{{ opt.image.url }}"
                                class="w-16 h-16 object-cover rounded-md border border-gray-300" alt="">
                            {% endif %}
                            <span class="text-gray-700">{{ opt.text }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    {% elif q.question_type == "text" %}
                    <input type="text" name="q_{{ q.id }}" placeholder="Введите короткий ответ"
                        class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">

                    {% elif q.question_type == "long_text" %}
                    <textarea name="q_{{ q.id }}" rows="4" placeholder="Введите развернутый ответ"
                        class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off"></textarea>

                    {% elif q.question_type == "number" %}
                    <input type="number" name="q_{{ q.id }}" placeholder="Введите число"
                        class="w-40 border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">

                    {% elif q.question_type == "order" %}
                    <div class="space-y-2">
                        <ul id="order_{{ q.id }}" class="list-none p-0">
                            {% for opt in q.options.all %}
                            <li class="bg-gray-100 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-indigo-50 transition relative"
                                data-option-id="{{ opt.id }}">
                                <span
                                    class="order-number absolute top-1 right-2 text-white bg-indigo-600 w-6 h-6 text-center rounded-full hidden"></span>
                                {{ opt.text }}
                            </li>
                            {% endfor %}
                        </ul>
                        <input type="hidden" name="q_{{ q.id }}" id="order_input_{{ q.id }}">
                        <p class="text-sm text-gray-500 mt-2">* Кликните по элементам в правильном порядке</p>
                    </div>

                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Кнопка отправки -->
        <div class="pt-4">
            <button type="submit" id="submit-button"
                class="w-full bg-indigo-600 text-white py-3.5 rounded-xl text-lg font-semibold shadow-md hover:bg-indigo-700 hover:shadow-lg active:scale-[0.98] transition">
                Отправить ответы
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    {% for q in questions %}
    {% if q.question_type == "order" %}
    const list = document.getElementById("order_{{ q.id }}");
    const input = document.getElementById("order_input_{{ q.id }}");
    let order = [];

    list.querySelectorAll("li").forEach(item => {
        item.addEventListener("click", () => {
            const optionId = item.dataset.optionId;

            if (order.includes(optionId)) return;

            order.push(optionId);

            const numberEl = item.querySelector(".order-number");
            numberEl.textContent = order.length;
            numberEl.classList.remove("hidden");

            input.value = JSON.stringify(order);
        });
    });

    const resetBtn = document.createElement("button");
    resetBtn.type = "button";
    resetBtn.textContent = "Сбросить порядок";
    resetBtn.className = "mt-2 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm";
    resetBtn.addEventListener("click", () => {
        order = [];
        input.value = "";
        list.querySelectorAll(".order-number").forEach(span => span.classList.add("hidden"));
    });
    list.after(resetBtn);
    {% endif %}
    {% endfor %}
});

(function() {
  // helper: CSRF cookie
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  const sessionId = "{{ session.id }}";
  const clientToken = document.getElementById("client_token").value;
  const maxWarnings = {{ test.max_warnings|default:3 }};
  const warningEl = document.getElementById("warning-count");
  const timerEl = document.getElementById("timer");
  const form = document.getElementById("test-form");

  // оставшееся время, полученное с сервера (в секундах)
  let remaining = {% if remaining_seconds is not None %}{{ remaining_seconds }}{% else %}null{% endif %};

  // безопасный fetch wrapper (POST JSON)
  function postJson(url, payload) {
    return fetch(url, {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken
      },
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }

  // Таймер
  let timerInterval = null;
  if (remaining !== null) {
    function updateTimerDisplay() {
      if (remaining <= 0) {
        clearInterval(timerInterval);
        // автосабмит
        form.submit();
        return;
      }
      const m = Math.floor(remaining / 60);
      const s = remaining % 60;
      timerEl.textContent = `${m}:${String(s).padStart(2,'0')}`;
      remaining--;
    }
    updateTimerDisplay();
    timerInterval = setInterval(updateTimerDisplay, 1000);
  }

  // Heartbeat — каждые 10 секунд уведомляем сервер
  const heartbeatUrl = "{% url 'tests:heartbeat' session.id %}";
  const warnUrl = "{% url 'tests:warn' session.id %}";
  let heartbeatTimer = setInterval(() => {
    postJson(heartbeatUrl, { token: clientToken }).catch(() => {
      // если heartbeat падает — пометка в консоль, но сервер всё равно проверит при submit
      console.warn("heartbeat failed");
    });
  }, 10000);

    function sendWarn(action) {
        postJson(warnUrl, { token: clientToken, action: action })
            .then(data => {
                warningEl.textContent =
                    `⚠️ Нарушения: ${data.tab_switches} из ${maxWarnings}, вне страницы: ${data.time_outside_seconds} сек`;
                if (data.submit) setTimeout(() => form.submit(), 300);
            });
    }

    document.addEventListener("visibilitychange", () => {
        if (document.hidden) sendWarn("blur");
        else sendWarn("focus");
    });
})();
</script>
{% endblock %}